"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BroadcastNodeMessageHandler = void 0;
const error_1 = require("../error");
const command_1 = require("./command");
const common_1 = require("../common");
class BroadcastNodeMessageHandler {
    static async handle(message, driver, client) {
        const { command } = message;
        const virtualNode = driver.controller.getBroadcastNode();
        switch (message.command) {
            case command_1.BroadcastNodeCommand.setValue: {
                const result = await virtualNode.setValue(message.valueId, message.value, message.options);
                return (0, common_1.setValueOutgoingMessage)(result, client.schemaVersion);
            }
            case command_1.BroadcastNodeCommand.getEndpointCount: {
                const count = virtualNode.getEndpointCount();
                return { count };
            }
            case command_1.BroadcastNodeCommand.supportsCC: {
                const supported = getVirtualEndpoint(virtualNode, message.index).supportsCC(message.commandClass);
                return { supported };
            }
            case command_1.BroadcastNodeCommand.getCCVersion: {
                const version = getVirtualEndpoint(virtualNode, message.index).getCCVersion(message.commandClass);
                return { version };
            }
            case command_1.BroadcastNodeCommand.invokeCCAPI: {
                const response = getVirtualEndpoint(virtualNode, message.index).invokeCCAPI(message.commandClass, message.methodName, ...message.args);
                return { response };
            }
            case command_1.BroadcastNodeCommand.supportsCCAPI: {
                const supported = getVirtualEndpoint(virtualNode, message.index).supportsCCAPI(message.commandClass);
                return { supported };
            }
            case command_1.BroadcastNodeCommand.getDefinedValueIDs: {
                const valueIDs = virtualNode.getDefinedValueIDs();
                return { valueIDs };
            }
            default: {
                throw new error_1.UnknownCommandError(command);
            }
        }
    }
}
exports.BroadcastNodeMessageHandler = BroadcastNodeMessageHandler;
function getVirtualEndpoint(virtualNode, index) {
    if (!index)
        return virtualNode;
    const virtualEndpoint = virtualNode.getEndpoint(index);
    if (!virtualEndpoint) {
        throw new error_1.VirtualEndpointNotFoundError(index, undefined, true);
    }
    return virtualEndpoint;
}
